<?php
if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Register extends MX_Controller {

   	public function __construct(){
        parent::__construct();
        // Your own constructor code
   	}

   	public function index(){
   		if($this->ion_auth->logged_in()){
			redirect(base_url());
		}
		else{
			$data['module']='register';
			$data['view']='registerpage';
			$data['description']='Moteur de recherche destiné aux universités du Cameroun';
			$data['title']='Dorothy - Crééez un compte';
			echo Modules::run('template/myapp',$data);
		}
	}

	public function create_user(){
		$config=array(
				array(
						'field'			=>	'first_name',
						'label'			=>	'First name',
						'rules'			=>	'required|xss_clean'					
					),
				array(
						'field'			=>	'last_name',
						'label'			=>	'Last name',
						'rules'			=>	'required|xss_clean'					
					),
				array(
						'field'			=>	'groupe',
						'label'			=>	'Groupe',
						'rules'			=>	'required|xss_clean'					
					),
				array(
						'field'			=>	'email',
						'label'			=>	'Email',
						'rules'			=>	'required|xss_clean|valid_email|is_unique[users.email]'					
					),
				array(
						'field'			=>	'password',
						'label'			=>	'Password',
						'rules'			=>	'required|xss_clean|min_length[6]|max_length[12]'					
					),
				array(
						'field'			=>	'password1',
						'label'			=>	'Password Confirmed',
						'rules'			=>	'required|xss_clean|matches[password]'					
					)
			);

		$this->form_validation->set_rules($config);

		if($this->form_validation->run()==false){
			$this->index();
		}else{
			$first_name=$this->input->post('first_name');
			$last_name=$this->input->post('last_name');
			$email=$this->input->post('email');
			$groupe=$this->input->post('groupe');
			$password=$this->input->post('password');

			$username=$first_name.' '.$last_name;
			$additional_data = array(
								'first_name' => $first_name,
								'last_name' => $last_name,
								);
			switch($groupe){
				case 'etudiant':
					$val=5;
					break;
				case 'enseignant':
					$val=4;
					break;
				case 'bibliothecaire':
					$val=3;
					break;
			}
			$group=array($val);
			$this->ion_auth->register($username, $password, $email, $additional_data, $group);

			require base_url().'vendor/phpmailer/PHPMailerAutoload.php';
			$mail = new PHPMailer;
			$mail->From = 'registration@dorothy.com';
			$mail->FromName = 'Dorothy';
			$mail->addAddress('pambeaba@kristdev.com', $username);
			$mail->addReplyTo('info@dorothy.com', 'Dorothy');
			$mail->isHTML(true);                                  // Set email format to HTML

			$mail->Subject = 'Your registration, '.$email;
			$mail->Body    = 'Welcome to Dorothy Search engine <b>'.$username.'</b>, your registration has been accepted.<br/> your account will validated in 24 hours, your username is <strong>'.$username.'</strong>, your password is <strong>'.$password.'</strong>';
			$mail->AltBody = 'This is the body in plain text for non-HTML mail clients';
			if(!$mail->send()) {
			    echo 'Message could not be sent.';
			    echo 'Mailer Error: ' . $mail->ErrorInfo;
			}else {
			    echo 'Message has been sent';
			}

			$data['message_confirmRegistration']='Check your mail to confirm your registration '.$username;
			$data['module']='register';
			$data['view']='registerpage';
			$data['description']='Moteur de recherche destiné aux universités du Cameroun';
			$data['title']='Dorothy - Crééez un compte';
			echo Modules::run('template/myapp',$data);

		}
	}

	
}
?>